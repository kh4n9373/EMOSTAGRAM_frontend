{"ast":null,"code":"var _jsxFileName = \"/Users/khangtuan/Documents/eq_test/eq_test_frontend_v2/src/views/page-chat.js\",\n  _s = $RefreshSig$(),\n  _s2 = $RefreshSig$(),\n  _s3 = $RefreshSig$();\nimport React, { useEffect, useRef, useState } from 'react';\nimport { Helmet } from 'react-helmet';\n// import VoiceRecorder from '../components/VoiceRecorder'\n// import AudioBubble from '../components/AudioBubble'\n/* ==== Icons ==== */\nimport { jsxDEV as _jsxDEV, Fragment as _Fragment } from \"react/jsx-dev-runtime\";\nconst IconPaperclip = props => /*#__PURE__*/_jsxDEV(\"svg\", {\n  width: \"20\",\n  height: \"20\",\n  viewBox: \"0 0 24 24\",\n  fill: \"none\",\n  stroke: \"currentColor\",\n  strokeWidth: \"1.7\",\n  ...props,\n  children: /*#__PURE__*/_jsxDEV(\"path\", {\n    d: \"M21 11L10 22a5 5 0 0 1-7-7l11-11a3 3 0 0 1 4 4L8 19a1.5 1.5 0 0 1-2-2l9-9\",\n    strokeLinecap: \"round\",\n    strokeLinejoin: \"round\"\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 8,\n    columnNumber: 5\n  }, this)\n}, void 0, false, {\n  fileName: _jsxFileName,\n  lineNumber: 7,\n  columnNumber: 3\n}, this);\n_c = IconPaperclip;\nconst IconMic = props => /*#__PURE__*/_jsxDEV(\"svg\", {\n  width: \"18\",\n  height: \"18\",\n  viewBox: \"0 0 24 24\",\n  fill: \"none\",\n  stroke: \"currentColor\",\n  strokeWidth: \"1.8\",\n  ...props,\n  children: [/*#__PURE__*/_jsxDEV(\"rect\", {\n    x: \"9\",\n    y: \"2\",\n    width: \"6\",\n    height: \"12\",\n    rx: \"3\"\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 14,\n    columnNumber: 5\n  }, this), /*#__PURE__*/_jsxDEV(\"path\", {\n    d: \"M5 11a7 7 0 0 0 14 0\"\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 15,\n    columnNumber: 5\n  }, this), /*#__PURE__*/_jsxDEV(\"path\", {\n    d: \"M12 19v3\"\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 16,\n    columnNumber: 5\n  }, this)]\n}, void 0, true, {\n  fileName: _jsxFileName,\n  lineNumber: 13,\n  columnNumber: 3\n}, this);\n_c2 = IconMic;\nconst IconCopy = props => /*#__PURE__*/_jsxDEV(\"svg\", {\n  width: \"18\",\n  height: \"18\",\n  viewBox: \"0 0 24 24\",\n  fill: \"none\",\n  ...props,\n  children: [/*#__PURE__*/_jsxDEV(\"rect\", {\n    x: \"9\",\n    y: \"9\",\n    width: \"11\",\n    height: \"11\",\n    rx: \"2\",\n    stroke: \"currentColor\",\n    strokeWidth: \"1.7\"\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 22,\n    columnNumber: 5\n  }, this), /*#__PURE__*/_jsxDEV(\"rect\", {\n    x: \"4\",\n    y: \"4\",\n    width: \"11\",\n    height: \"11\",\n    rx: \"2\",\n    stroke: \"currentColor\",\n    strokeWidth: \"1.7\"\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 23,\n    columnNumber: 5\n  }, this)]\n}, void 0, true, {\n  fileName: _jsxFileName,\n  lineNumber: 21,\n  columnNumber: 3\n}, this);\n_c3 = IconCopy;\nconst IconThumbUp = props => /*#__PURE__*/_jsxDEV(\"svg\", {\n  width: \"18\",\n  height: \"18\",\n  viewBox: \"0 0 24 24\",\n  fill: \"none\",\n  ...props,\n  children: /*#__PURE__*/_jsxDEV(\"path\", {\n    d: \"M14 10V5a2 2 0 0 0-2-2l-3 7H5a2 2 0 0 0-2 2v7h10.3a3 3 0 0 0 2.9-2.1l2.1-6.2A2 2 0 0 0 16.4 9H14z\",\n    stroke: \"currentColor\",\n    strokeWidth: \"1.7\",\n    strokeLinejoin: \"round\"\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 29,\n    columnNumber: 5\n  }, this)\n}, void 0, false, {\n  fileName: _jsxFileName,\n  lineNumber: 28,\n  columnNumber: 3\n}, this);\n_c4 = IconThumbUp;\nconst IconThumbDown = props => /*#__PURE__*/_jsxDEV(\"svg\", {\n  width: \"18\",\n  height: \"18\",\n  viewBox: \"0 0 24 24\",\n  fill: \"none\",\n  ...props,\n  children: /*#__PURE__*/_jsxDEV(\"path\", {\n    d: \"M10 14v5a2 2 0 0 0 2 2l3-7h4a2 2 0 0 0 2-2V5H10.7a3 3 0 0 0-2.9 2.1L5.7 13.3A2 2 0 0 0 7.6 16H10z\",\n    stroke: \"currentColor\",\n    strokeWidth: \"1.7\",\n    strokeLinejoin: \"round\"\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 35,\n    columnNumber: 5\n  }, this)\n}, void 0, false, {\n  fileName: _jsxFileName,\n  lineNumber: 34,\n  columnNumber: 3\n}, this);\n\n/*  Buttons (copy/like/dislike) */\n_c5 = IconThumbDown;\nconst actionBtnStyle = (active = false) => ({\n  background: active ? '#111827' : '#fff',\n  border: `1px solid ${active ? '#111827' : '#e5e7eb'}`,\n  color: active ? '#ffffff' : '#6b7280',\n  padding: '6px 10px',\n  borderRadius: 10,\n  display: 'inline-flex',\n  alignItems: 'center',\n  gap: 6,\n  cursor: 'pointer',\n  boxShadow: active ? '0 2px 10px rgba(0,0,0,0.15)' : '0 1px 4px rgba(0,0,0,0.04)',\n  userSelect: 'none',\n  transition: 'all .15s ease'\n});\n\n/* ==== Avatar ==== */\nconst Avatar = () => /*#__PURE__*/_jsxDEV(\"div\", {\n  style: {\n    width: 64,\n    height: 64,\n    borderRadius: 12,\n    background: '#e5e7eb',\n    display: 'grid',\n    placeItems: 'center'\n  },\n  children: /*#__PURE__*/_jsxDEV(\"span\", {\n    style: {\n      fontWeight: 700\n    },\n    children: \"E\"\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 58,\n    columnNumber: 5\n  }, this)\n}, void 0, false, {\n  fileName: _jsxFileName,\n  lineNumber: 57,\n  columnNumber: 3\n}, this);\n\n/* ==== Lightbox ==== */\n_c6 = Avatar;\nconst Lightbox = ({\n  src,\n  alt,\n  open,\n  onClose\n}) => {\n  _s();\n  // khoá scroll nền khi mở\n  useEffect(() => {\n    if (!open) return;\n    const prev = document.body.style.overflow;\n    document.body.style.overflow = 'hidden';\n    return () => {\n      document.body.style.overflow = prev;\n    };\n  }, [open]);\n  useEffect(() => {\n    if (!open) return;\n    const onKey = e => {\n      if (e.key === 'Escape') onClose === null || onClose === void 0 ? void 0 : onClose();\n    };\n    window.addEventListener('keydown', onKey);\n    return () => window.removeEventListener('keydown', onKey);\n  }, [open, onClose]);\n  if (!open) return null;\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    role: \"dialog\",\n    \"aria-modal\": \"true\",\n    onClick: e => {\n      if (e.target === e.currentTarget) onClose === null || onClose === void 0 ? void 0 : onClose();\n    },\n    style: {\n      position: 'fixed',\n      inset: 0,\n      zIndex: 9999,\n      background: 'rgba(15,23,42,.55)',\n      backdropFilter: 'blur(2px)',\n      display: 'grid',\n      placeItems: 'center',\n      padding: 16\n    },\n    children: [/*#__PURE__*/_jsxDEV(\"button\", {\n      onClick: onClose,\n      \"aria-label\": \"Close\",\n      style: {\n        position: 'absolute',\n        top: 16,\n        right: 16,\n        width: 36,\n        height: 36,\n        borderRadius: '50%',\n        background: 'rgba(255,255,255,.9)',\n        border: '1px solid #e5e7eb',\n        display: 'grid',\n        placeItems: 'center',\n        fontWeight: 700,\n        cursor: 'pointer'\n      },\n      children: \"\\xD7\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 93,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"img\", {\n      src: src,\n      alt: alt || 'preview',\n      style: {\n        maxWidth: 'min(92vw, 1000px)',\n        maxHeight: 'min(92vh, 1000px)',\n        objectFit: 'contain',\n        borderRadius: 16,\n        boxShadow: '0 20px 60px rgba(0,0,0,.35)',\n        background: '#0b0f19'\n      }\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 104,\n      columnNumber: 7\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 81,\n    columnNumber: 5\n  }, this);\n};\n\n/* ==== Message Bubble ==== */\n_s(Lightbox, \"3ubReDTFssvu4DHeldAg55cW/CI=\");\n_c7 = Lightbox;\nconst MessageBubble = ({\n  role,\n  children,\n  media,\n  onImageLoad,\n  onPreview,\n  isStreaming = false\n}) => {\n  const isUser = role === 'user';\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    style: {\n      display: 'grid',\n      justifyItems: isUser ? 'end' : 'start'\n    },\n    children: /*#__PURE__*/_jsxDEV(\"div\", {\n      style: {\n        maxWidth: 720,\n        background: isUser ? '#111827' : '#ffffff',\n        color: isUser ? 'white' : '#111827',\n        border: isUser ? 'none' : '1px solid #e5e7eb',\n        padding: media ? 8 : 12,\n        borderRadius: 16,\n        boxShadow: isUser ? '0 4px 14px rgba(0,0,0,0.15)' : '0 4px 14px rgba(0,0,0,0.06)',\n        display: 'inline-block',\n        width: 'fit-content',\n        lineHeight: 1.6\n      },\n      children: media ? /*#__PURE__*/_jsxDEV(\"img\", {\n        src: media,\n        alt: \"attachment\",\n        onLoad: onImageLoad,\n        onClick: () => onPreview === null || onPreview === void 0 ? void 0 : onPreview(media),\n        style: {\n          width: 260,\n          borderRadius: 12,\n          cursor: 'zoom-in',\n          display: 'block'\n        }\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 138,\n        columnNumber: 11\n      }, this) : /*#__PURE__*/_jsxDEV(\"div\", {\n        style: {\n          whiteSpace: 'pre-wrap'\n        },\n        children: children\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 146,\n        columnNumber: 11\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 125,\n      columnNumber: 7\n    }, this)\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 124,\n    columnNumber: 5\n  }, this);\n};\n\n/* ==== Typing indicator bubble (iMessage/Messenger style) ==== */\n_c8 = MessageBubble;\nconst TypingBubble = () => {\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    style: {\n      display: 'grid',\n      justifyItems: 'start',\n      marginBottom: 16\n    },\n    children: /*#__PURE__*/_jsxDEV(\"div\", {\n      style: {\n        position: 'relative',\n        background: '#ebeef2',\n        height: 50,\n        color: '#374151',\n        border: '1px solid #e5e7eb',\n        borderRadius: 20,\n        padding: '10px 14px',\n        display: 'inline-flex',\n        alignItems: 'center',\n        gap: 6,\n        boxShadow: '0 4px 14px rgba(0,0,0,0.06)'\n      },\n      children: [/*#__PURE__*/_jsxDEV(\"span\", {\n        style: {\n          width: 8,\n          height: 8,\n          borderRadius: '50%',\n          background: '#9ca3af',\n          animation: 'typingDot 1.2s infinite ease-in-out'\n        }\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 170,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(\"span\", {\n        style: {\n          width: 8,\n          height: 8,\n          borderRadius: '50%',\n          background: '#9ca3af',\n          animation: 'typingDot 1.2s infinite ease-in-out .15s'\n        }\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 171,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(\"span\", {\n        style: {\n          width: 8,\n          height: 8,\n          borderRadius: '50%',\n          background: '#9ca3af',\n          animation: 'typingDot 1.2s infinite ease-in-out .3s'\n        }\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 172,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(\"span\", {\n        style: {\n          position: 'absolute',\n          left: -6,\n          bottom: -2,\n          width: 10,\n          height: 10,\n          borderRadius: '50%',\n          background: '#ebeef2',\n          border: '1px solid #e5e7eb'\n        }\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 175,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(\"span\", {\n        style: {\n          position: 'absolute',\n          left: -14,\n          bottom: -6,\n          width: 8,\n          height: 8,\n          borderRadius: '50%',\n          background: '#ebeef2',\n          border: '1px solid #e5e7eb'\n        }\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 176,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 157,\n      columnNumber: 7\n    }, this)\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 156,\n    columnNumber: 5\n  }, this);\n};\n\n/* ==== Auto Textarea ==== */\n_c9 = TypingBubble;\nconst AutoTextarea = /*#__PURE__*/_s2(/*#__PURE__*/React.forwardRef(_c0 = _s2(function AutoTextarea({\n  value,\n  onChange,\n  onSend,\n  placeholder,\n  style\n}, ref) {\n  _s2();\n  const localRef = useRef(null);\n  const textareaRef = ref || localRef;\n  const autoSize = () => {\n    const el = textareaRef.current;\n    if (!el) return;\n    el.style.height = 'auto';\n    const max = 240;\n    const h = Math.min(el.scrollHeight, max);\n    el.style.height = h + 'px';\n    el.style.overflowY = el.scrollHeight > max ? 'auto' : 'hidden';\n  };\n  useEffect(() => {\n    autoSize();\n  }, [value]);\n  const onKeyDown = e => {\n    if (e.key === 'Enter') {\n      if (e.metaKey || e.ctrlKey || e.shiftKey) return;\n      e.preventDefault();\n      onSend === null || onSend === void 0 ? void 0 : onSend();\n    }\n  };\n  return /*#__PURE__*/_jsxDEV(\"textarea\", {\n    ref: textareaRef,\n    value: value,\n    onChange: e => {\n      onChange(e);\n      requestAnimationFrame(autoSize);\n    },\n    onKeyDown: onKeyDown,\n    placeholder: placeholder,\n    rows: 1,\n    style: {\n      flex: 1,\n      background: 'transparent',\n      color: '#111827',\n      border: 'none',\n      outline: 'none',\n      padding: '12px 12px',\n      fontSize: 18,\n      lineHeight: '24px',\n      minHeight: 44,\n      resize: 'none',\n      overflow: 'hidden',\n      whiteSpace: 'pre-wrap',\n      wordBreak: 'break-word',\n      ...style\n    },\n    \"aria-label\": \"Message input\"\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 211,\n    columnNumber: 5\n  }, this);\n}, \"28K6HmXVpFGf/iqhT8LTjwTKC6E=\")), \"28K6HmXVpFGf/iqhT8LTjwTKC6E=\");\n\n/* ==== Small toast ==== */\n_c1 = AutoTextarea;\nconst Toast = ({\n  show,\n  children\n}) => /*#__PURE__*/_jsxDEV(\"div\", {\n  \"aria-live\": \"polite\",\n  style: {\n    position: 'absolute',\n    top: -100,\n    left: '50%',\n    transform: 'translateX(-50%)',\n    opacity: show ? 1 : 0,\n    transition: 'opacity .2s ease',\n    pointerEvents: 'none'\n  },\n  children: /*#__PURE__*/_jsxDEV(\"div\", {\n    style: {\n      background: '#111827',\n      color: 'white',\n      padding: '6px 10px',\n      borderRadius: 999,\n      fontSize: 12,\n      boxShadow: '0 6px 18px rgba(0,0,0,.18)'\n    },\n    children: children\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 242,\n    columnNumber: 5\n  }, this)\n}, void 0, false, {\n  fileName: _jsxFileName,\n  lineNumber: 241,\n  columnNumber: 3\n}, this);\n\n/* ==== Main Page ==== */\n_c10 = Toast;\nconst ChatPage = () => {\n  _s3();\n  const CHAT_SERVICE_BASE = \"http://localhost:5002\";\n  const [messages, setMessages] = useState([]);\n  const [text, setText] = useState('');\n  const [mediaPreview, setMediaPreview] = useState(null);\n  const [mediaFile, setMediaFile] = useState(null);\n  const [recording, setRecording] = useState(false);\n  // Ensure user is defined to avoid ReferenceError in sendMessage\n  const [user, setUser] = useState(null);\n  const barRef = useRef(null);\n  const barInnerRef = useRef(null);\n  const [bottomPad, setBottomPad] = useState(96);\n  const [ratings, setRatings] = useState({});\n  const [copiedId, setCopiedId] = useState(null);\n  const [streamingText, setStreamingText] = useState('');\n  const [isStreaming, setIsStreaming] = useState(false);\n  const [historyCursor, setHistoryCursor] = useState(null);\n  const [loadingHistory, setLoadingHistory] = useState(false);\n  const [hasMore, setHasMore] = useState(true);\n  const [chatActivated, setChatActivated] = useState(false);\n  const [historyBuffer, setHistoryBuffer] = useState([]);\n\n  // Lightbox\n  const [lightboxOpen, setLightboxOpen] = useState(false);\n  const [lightboxSrc, setLightboxSrc] = useState(null);\n\n  // ---- Anchor & scroll helpers ----\n  const anchorMsgIdRef = useRef(null);\n  const messagesListRef = useRef(null);\n  const topSentinelRef = useRef(null);\n  const inFlightCursorRef = useRef(null);\n  const scrollToMsgById = (id, behavior = 'smooth', offset = 16) => {\n    const el = document.querySelector(`[data-mid=\"${id}\"]`);\n    if (!el) return;\n    const top = el.getBoundingClientRect().top + window.scrollY - offset;\n    window.scrollTo({\n      top,\n      behavior\n    });\n  };\n\n  /* ==== Padding theo chiều cao input bar ==== */\n  useEffect(() => {\n    if (!barRef.current) return;\n    const update = () => {\n      var _barRef$current$offse, _barRef$current;\n      const h = (_barRef$current$offse = (_barRef$current = barRef.current) === null || _barRef$current === void 0 ? void 0 : _barRef$current.offsetHeight) !== null && _barRef$current$offse !== void 0 ? _barRef$current$offse : 0;\n      setBottomPad(h + 16);\n    };\n    const ro = new ResizeObserver(update);\n    ro.observe(barRef.current);\n    window.addEventListener('resize', update);\n    update();\n    return () => {\n      ro.disconnect();\n      window.removeEventListener('resize', update);\n    };\n  }, []);\n\n  // History helpers\n  const mapItemToMessage = d => ({\n    id: d.message_id || d.id || Date.now(),\n    role: d.role === 'assistant' ? 'assistant' : 'user',\n    text: d.content || ''\n  });\n  const fetchHistory = async (cursor = null, toBuffer = false) => {\n    if (!(user !== null && user !== void 0 && user.id) || loadingHistory) return;\n    if (cursor && inFlightCursorRef.current === cursor) return;\n    setLoadingHistory(true);\n    inFlightCursorRef.current = cursor || '__initial__';\n    try {\n      const url = new URL(`/v1/conversation/${encodeURIComponent(user.id)}`, CHAT_SERVICE_BASE);\n      url.searchParams.set('page_size', '10');\n      if (cursor) url.searchParams.set('cursor', cursor);\n      const res = await fetch(url.toString());\n      if (!res.ok) throw new Error('history fetch failed');\n      const j = await res.json();\n      const items = Array.isArray(j === null || j === void 0 ? void 0 : j.items) ? j.items : [];\n      const ascending = [...items].reverse().map(mapItemToMessage);\n      if (!chatActivated && !cursor) {\n        // Only buffer initial history; do not render yet\n        setHistoryBuffer(ascending);\n      } else if (cursor) {\n        const listEl = messagesListRef.current;\n        const prevHeight = listEl ? listEl.scrollHeight : document.documentElement.scrollHeight;\n        setMessages(m => [...ascending, ...m]);\n        setTimeout(() => {\n          const newHeight = listEl ? listEl.scrollHeight : document.documentElement.scrollHeight;\n          if (listEl) {\n            listEl.scrollTop = newHeight - prevHeight;\n          } else {\n            window.scrollBy(0, newHeight - prevHeight);\n          }\n        }, 0);\n      } else {\n        setMessages(ascending);\n        setTimeout(() => {\n          if (messagesListRef.current) {\n            messagesListRef.current.scrollTop = messagesListRef.current.scrollHeight;\n          }\n        }, 0);\n      }\n      setHistoryCursor((j === null || j === void 0 ? void 0 : j.next_cursor) || null);\n      setHasMore(Boolean(j === null || j === void 0 ? void 0 : j.next_cursor));\n    } catch (_) {} finally {\n      setLoadingHistory(false);\n      inFlightCursorRef.current = null;\n    }\n  };\n  useEffect(() => {\n    if (user !== null && user !== void 0 && user.id) fetchHistory(null, true); // prefetch into buffer only\n    // eslint-disable-next-line\n  }, [user === null || user === void 0 ? void 0 : user.id]);\n  const onHistoryScroll = e => {\n    if (!chatActivated) return;\n    const el = e.currentTarget;\n    if (el.scrollTop <= 100 && historyCursor && !loadingHistory) {\n      fetchHistory(historyCursor);\n    }\n  };\n\n  // Also observe window scroll for cases when body is the scroller\n  useEffect(() => {\n    const onWinScroll = () => {\n      if (!chatActivated) return;\n      const top = Math.min(document.documentElement.scrollTop || 0, window.scrollY || 0);\n      if (top <= 100 && historyCursor && !loadingHistory) {\n        fetchHistory(historyCursor);\n      }\n    };\n    window.addEventListener('scroll', onWinScroll, {\n      passive: true\n    });\n    return () => window.removeEventListener('scroll', onWinScroll);\n  }, [chatActivated, historyCursor, loadingHistory]);\n\n  // IntersectionObserver to reliably detect when top enters viewport\n  useEffect(() => {\n    if (!topSentinelRef.current) return;\n    const observer = new IntersectionObserver(entries => {\n      const entry = entries[0];\n      if (!chatActivated) return;\n      if (entry.isIntersecting && historyCursor && !loadingHistory) {\n        fetchHistory(historyCursor);\n      }\n    }, {\n      root: null,\n      rootMargin: '0px',\n      threshold: 0\n    });\n    observer.observe(topSentinelRef.current);\n    return () => observer.disconnect();\n  }, [chatActivated, historyCursor, loadingHistory]);\n  useEffect(() => {\n    const el = barInnerRef.current;\n    if (!el) return;\n    const compute = () => {\n      const rect = el.getBoundingClientRect();\n      const cs = window.getComputedStyle(el);\n      const margin = parseFloat(cs.marginTop) + parseFloat(cs.marginBottom);\n      setBottomPad(rect.height + margin + 8);\n    };\n    compute();\n    const ro = new ResizeObserver(compute);\n    ro.observe(el);\n    window.addEventListener('resize', compute);\n    return () => {\n      ro.disconnect();\n      window.removeEventListener('resize', compute);\n    };\n  }, []);\n\n  // Load current user info (best-effort)\n  useEffect(() => {\n    (async () => {\n      try {\n        const res = await fetch('/api/v1/users/me', {\n          credentials: 'include'\n        });\n        if (!res.ok) return;\n        const j = await res.json();\n        setUser((j === null || j === void 0 ? void 0 : j.data) || null);\n      } catch (_) {}\n    })();\n  }, []);\n\n  /* ==== Copy/Rate ==== */\n  const handleRate = (id, val) => setRatings(prev => ({\n    ...prev,\n    [id]: prev[id] === val ? undefined : val\n  }));\n  const handleCopy = async (id, textVal) => {\n    try {\n      await navigator.clipboard.writeText(textVal);\n      setCopiedId(id);\n      setTimeout(() => setCopiedId(null), 1200);\n    } catch {}\n  };\n  // const handleSendAudio = ({ blob, url, duration, peaks }) => {\n  //   const id = Date.now()\n  //   // anchor tới message audio mới\n  //   anchorMsgIdRef.current = id\n  //   // thêm message audio vào list\n  //   setMessages(m => m.concat({\n  //     id,\n  //     role: 'user',\n  //     audio: { url, duration, peaks }   // <— AudioBubble sẽ dùng 3 field này\n  //   }))\n  //   // sau render: nhảy viewport tới message audio\n  //   setTimeout(() => {\n  //     if (anchorMsgIdRef.current) scrollToMsgById(anchorMsgIdRef.current, 'smooth')\n  //   }, 0)\n  // }\n  /* ==== Send ==== */\n  const sendMessage = async () => {\n    if (!text && !mediaPreview) return;\n    const now = Date.now();\n    const newMsgs = [];\n    if (mediaPreview) newMsgs.push({\n      id: now,\n      role: 'user',\n      media: mediaPreview\n    });\n    if (text) newMsgs.push({\n      id: now + 1,\n      role: 'user',\n      text\n    });\n    const userAnchorId = newMsgs[newMsgs.length - 1].id;\n    anchorMsgIdRef.current = userAnchorId;\n    if (!chatActivated) {\n      setMessages(() => historyBuffer.concat(newMsgs));\n      setChatActivated(true);\n      setHistoryBuffer([]);\n    } else {\n      setMessages(m => m.concat(newMsgs));\n    }\n    setText('');\n    setMediaPreview(null);\n    setMediaFile(null);\n    setTimeout(() => {\n      if (anchorMsgIdRef.current) scrollToMsgById(userAnchorId, 'smooth');\n    }, 0);\n\n    // Create assistant message for fake streaming\n    const assistantId = Date.now() + 2;\n    anchorMsgIdRef.current = assistantId;\n    setMessages(m => m.concat({\n      id: assistantId,\n      role: 'assistant',\n      text: ''\n    }));\n    setIsStreaming(true);\n    try {\n      var _user$id, _user$name;\n      // Use regular chat endpoint for faster response\n      const CHAT_SERVICE_BASE = \"http://localhost:5002\";\n      const res = await fetch(`${CHAT_SERVICE_BASE}/v1/letta/chat`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json'\n        },\n        // credentials removed to satisfy CORS when allow_origins is \"*\"\n        body: JSON.stringify({\n          //  content: text || '[media]' \n          user_id: (_user$id = user === null || user === void 0 ? void 0 : user.id) !== null && _user$id !== void 0 ? _user$id : null,\n          username: (_user$name = user === null || user === void 0 ? void 0 : user.name) !== null && _user$name !== void 0 ? _user$name : 'Guest',\n          message: text || '[media]'\n        })\n      });\n      if (!res.ok) throw new Error('Network response was not ok');\n      const j = await res.json();\n      const fullReply = (j === null || j === void 0 ? void 0 : j.message) || 'Chào bạn! Bạn muốn hỏi thêm gì về Emostagram?';\n      const genTimeSec = j === null || j === void 0 ? void 0 : j.gen_time_sec;\n\n      // Fake streaming effect - show text word by word\n      const words = fullReply.split(' ');\n      let currentText = '';\n      for (let i = 0; i < words.length; i++) {\n        currentText += (i > 0 ? ' ' : '') + words[i];\n\n        // Update message with current text\n        setMessages(m => m.map(msg => msg.id === assistantId ? {\n          ...msg,\n          text: currentText\n        } : msg));\n\n        // Small delay to make streaming visible\n        await new Promise(resolve => setTimeout(resolve, 50));\n      }\n\n      // Streaming finished\n      setIsStreaming(false);\n      setTimeout(() => {\n        if (anchorMsgIdRef.current) scrollToMsgById(assistantId, 'smooth');\n      }, 0);\n\n      // Attach generation time to this assistant message so UI can render it\n      if (typeof genTimeSec === 'number') {\n        setMessages(m => m.map(msg => msg.id === assistantId ? {\n          ...msg,\n          genTimeSec\n        } : msg));\n      }\n    } catch (error) {\n      console.error('Chat error:', error);\n      setIsStreaming(false);\n      // Update the assistant message with error\n      setMessages(m => m.map(msg => msg.id === assistantId ? {\n        ...msg,\n        text: 'Sorry, something went wrong. Please try again.'\n      } : msg));\n    }\n  };\n\n  // Voice input\n  const startVoice = () => {\n    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {\n      alert('Voice input not supported in this browser');\n      return;\n    }\n    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;\n    const rec = new SR();\n    rec.lang = 'vi-VN';\n    rec.interimResults = false;\n    rec.maxAlternatives = 1;\n    setRecording(true);\n    rec.onresult = e => {\n      const t = e.results[0][0].transcript;\n      setText(prev => prev ? prev + ' ' + t : t);\n    };\n    rec.onend = () => setRecording(false);\n    rec.onerror = () => setRecording(false);\n    rec.start();\n  };\n  const onPickMedia = e => {\n    var _e$target$files;\n    const f = (_e$target$files = e.target.files) === null || _e$target$files === void 0 ? void 0 : _e$target$files[0];\n    if (!f) return;\n    const url = URL.createObjectURL(f);\n    setMediaPreview(url);\n    setMediaFile(f);\n    // reset để chọn lại cùng file vẫn onChange\n    e.target.value = \"\";\n  };\n  const showHero = !chatActivated;\n  return /*#__PURE__*/_jsxDEV(\"main\", {\n    style: {\n      minHeight: '100vh',\n      background: '#f8fafc',\n      color: '#111827'\n    },\n    children: [/*#__PURE__*/_jsxDEV(Helmet, {\n      children: [/*#__PURE__*/_jsxDEV(\"title\", {\n        children: \"Chat - Emostagram\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 577,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(\"style\", {\n        children: `\n          @keyframes bounce {\n            0%, 80%, 100% { \n              transform: translateY(2px);\n              opacity: .6;\n            }\n            40% { \n              transform: translateY(-2px);\n              opacity: 1;\n            }\n          }\n          @keyframes typingDot {\n            0%, 80%, 100% { \n              transform: translateY(2px);\n              opacity: .55;\n            }\n            40% { \n              transform: translateY(-2px);\n              opacity: 1;\n            }\n          }\n        `\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 578,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 576,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(Lightbox, {\n      src: lightboxSrc,\n      alt: \"image preview\",\n      open: lightboxOpen,\n      onClose: () => {\n        setLightboxOpen(false);\n        setLightboxSrc(null);\n      }\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 603,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n      style: {\n        maxWidth: 980,\n        margin: '0 auto',\n        padding: '16px 16px 0 16px',\n        display: 'grid',\n        gap: 16\n      },\n      children: showHero ? /*#__PURE__*/_jsxDEV(\"div\", {\n        style: {\n          minHeight: '70vh',\n          display: 'grid',\n          alignContent: 'center',\n          justifyItems: 'center',\n          gap: 20\n        },\n        children: [/*#__PURE__*/_jsxDEV(Avatar, {}, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 613,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(\"h1\", {\n          style: {\n            marginTop: 8,\n            fontSize: 36,\n            fontWeight: 700\n          },\n          children: \"Emostagram\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 614,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          style: {\n            width: '100%',\n            display: 'grid',\n            justifyItems: 'center',\n            gap: 12\n          },\n          children: [mediaPreview && /*#__PURE__*/_jsxDEV(\"img\", {\n            src: mediaPreview,\n            alt: \"preview\",\n            style: {\n              width: 72,\n              height: 72,\n              objectFit: 'cover',\n              borderRadius: 14,\n              boxShadow: '0 8px 26px rgba(0,0,0,0.12)'\n            }\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 617,\n            columnNumber: 17\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            style: {\n              width: 'min(92vw, 760px)',\n              background: '#ffffff',\n              border: '1px solid #e5e7eb',\n              borderRadius: 18,\n              boxShadow: '0 12px 40px rgba(0,0,0,0.06)',\n              display: 'flex',\n              alignItems: 'flex-end',\n              padding: 8,\n              gap: 8\n            },\n            children: [/*#__PURE__*/_jsxDEV(\"button\", {\n              \"aria-label\": \"attach\",\n              onClick: () => {\n                var _document$getElementB;\n                return (_document$getElementB = document.getElementById('hero-file')) === null || _document$getElementB === void 0 ? void 0 : _document$getElementB.click();\n              },\n              style: {\n                width: 44,\n                height: 44,\n                borderRadius: 12,\n                border: '1px solid #e5e7eb',\n                background: '#fff',\n                color: '#6b7280',\n                display: 'grid',\n                placeItems: 'center',\n                boxShadow: '0 1px 4px rgba(0,0,0,0.04)',\n                flexShrink: 0\n              },\n              children: /*#__PURE__*/_jsxDEV(IconPaperclip, {}, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 641,\n                columnNumber: 19\n              }, this)\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 630,\n              columnNumber: 17\n            }, this), /*#__PURE__*/_jsxDEV(\"input\", {\n              id: \"hero-file\",\n              accept: \"*/*\",\n              type: \"file\",\n              style: {\n                display: 'none'\n              },\n              onChange: onPickMedia\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 643,\n              columnNumber: 17\n            }, this), /*#__PURE__*/_jsxDEV(AutoTextarea, {\n              value: text,\n              onChange: e => setText(e.target.value),\n              onSend: sendMessage,\n              placeholder: \"What do you want to know?\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 645,\n              columnNumber: 17\n            }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n              onClick: startVoice,\n              \"aria-label\": \"voice\",\n              title: \"Voice\",\n              style: {\n                width: 44,\n                height: 44,\n                borderRadius: '50%',\n                background: '#0f172a',\n                color: 'white',\n                border: '1px solid #0f172a',\n                display: 'grid',\n                placeItems: 'center',\n                boxShadow: '0 12px 28px rgba(2,6,23,0.35)',\n                flexShrink: 0\n              },\n              children: /*#__PURE__*/_jsxDEV(IconMic, {}, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 664,\n                columnNumber: 19\n              }, this)\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 652,\n              columnNumber: 17\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 619,\n            columnNumber: 15\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 615,\n          columnNumber: 13\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 612,\n        columnNumber: 11\n      }, this) : /*#__PURE__*/_jsxDEV(_Fragment, {\n        children: [/*#__PURE__*/_jsxDEV(\"div\", {\n          ref: messagesListRef,\n          style: {\n            display: 'grid',\n            gap: 6,\n            padding: '0 8px',\n            alignItems: 'start',\n            gridAutoRows: 'max-content',\n            margin: 0,\n            paddingBottom: `calc(${bottomPad}px + env(safe-area-inset-bottom, 0px))`\n          },\n          onScroll: onHistoryScroll,\n          children: [/*#__PURE__*/_jsxDEV(\"div\", {\n            ref: topSentinelRef,\n            style: {\n              height: 1\n            }\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 685,\n            columnNumber: 15\n          }, this), chatActivated && historyCursor && /*#__PURE__*/_jsxDEV(\"div\", {\n            style: {\n              display: 'grid',\n              justifyItems: 'center',\n              margin: '8px 0'\n            },\n            children: /*#__PURE__*/_jsxDEV(\"button\", {\n              onClick: () => fetchHistory(historyCursor),\n              style: {\n                padding: '6px 10px',\n                borderRadius: 10,\n                border: '1px solid #e5e7eb',\n                background: '#fff',\n                color: '#6b7280',\n                cursor: loadingHistory ? 'not-allowed' : 'pointer'\n              },\n              disabled: loadingHistory,\n              children: loadingHistory ? 'Loading…' : 'Load earlier messages'\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 688,\n              columnNumber: 19\n            }, this)\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 687,\n            columnNumber: 17\n          }, this), messages.map(m => {\n            const rated = ratings[m.id];\n            return /*#__PURE__*/_jsxDEV(\"div\", {\n              \"data-mid\": m.id,\n              style: {\n                display: 'grid',\n                gap: 6,\n                scrollMarginTop: 16\n              },\n              children: [isStreaming && m.role === 'assistant' && m.id === anchorMsgIdRef.current && !m.text ? /*#__PURE__*/_jsxDEV(TypingBubble, {}, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 709,\n                columnNumber: 21\n              }, this) : m.audio ?\n              /*#__PURE__*/\n              // ==== Bubble AUDIO ====\n              _jsxDEV(\"div\", {\n                style: {\n                  padding: 12,\n                  background: '#f3f4f6',\n                  borderRadius: 12,\n                  border: '1px solid #e5e7eb'\n                },\n                children: [\"Audio message (duration: \", m.audio.duration, \"s)\"]\n              }, void 0, true, {\n                fileName: _jsxFileName,\n                lineNumber: 712,\n                columnNumber: 21\n              }, this) : /*#__PURE__*/_jsxDEV(MessageBubble, {\n                role: m.role,\n                media: m.media,\n                onPreview: src => {\n                  setLightboxSrc(src);\n                  setLightboxOpen(true);\n                },\n                onImageLoad: () => {\n                  if (anchorMsgIdRef.current === m.id) {\n                    const id = m.id;\n                    requestAnimationFrame(() => scrollToMsgById(id, 'auto'));\n                  }\n                },\n                isStreaming: isStreaming && m.role === 'assistant' && m.id === anchorMsgIdRef.current,\n                children: m.text\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 716,\n                columnNumber: 21\n              }, this), m.role === 'assistant' && !(isStreaming && m.id === anchorMsgIdRef.current) && m.text && /*#__PURE__*/_jsxDEV(\"div\", {\n                style: {\n                  position: 'relative'\n                },\n                children: [/*#__PURE__*/_jsxDEV(Toast, {\n                  show: copiedId === m.id,\n                  children: \"Copy th\\xE0nh c\\xF4ng\"\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 733,\n                  columnNumber: 25\n                }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n                  style: {\n                    display: 'flex',\n                    gap: 8,\n                    alignItems: 'center'\n                  },\n                  children: [/*#__PURE__*/_jsxDEV(\"button\", {\n                    \"aria-label\": \"copy\",\n                    onClick: () => handleCopy(m.id, m.text),\n                    style: actionBtnStyle(copiedId === m.id),\n                    children: /*#__PURE__*/_jsxDEV(IconCopy, {}, void 0, false, {\n                      fileName: _jsxFileName,\n                      lineNumber: 735,\n                      columnNumber: 136\n                    }, this)\n                  }, void 0, false, {\n                    fileName: _jsxFileName,\n                    lineNumber: 735,\n                    columnNumber: 27\n                  }, this), (rated === undefined || rated === 'up') && /*#__PURE__*/_jsxDEV(\"button\", {\n                    \"aria-label\": \"like\",\n                    onClick: () => handleRate(m.id, 'up'),\n                    style: actionBtnStyle(rated === 'up'),\n                    title: \"Like\",\n                    children: /*#__PURE__*/_jsxDEV(IconThumbUp, {}, void 0, false, {\n                      fileName: _jsxFileName,\n                      lineNumber: 737,\n                      columnNumber: 146\n                    }, this)\n                  }, void 0, false, {\n                    fileName: _jsxFileName,\n                    lineNumber: 737,\n                    columnNumber: 29\n                  }, this), (rated === undefined || rated === 'down') && /*#__PURE__*/_jsxDEV(\"button\", {\n                    \"aria-label\": \"dislike\",\n                    onClick: () => handleRate(m.id, 'down'),\n                    style: actionBtnStyle(rated === 'down'),\n                    title: \"Dislike\",\n                    children: /*#__PURE__*/_jsxDEV(IconThumbDown, {}, void 0, false, {\n                      fileName: _jsxFileName,\n                      lineNumber: 740,\n                      columnNumber: 156\n                    }, this)\n                  }, void 0, false, {\n                    fileName: _jsxFileName,\n                    lineNumber: 740,\n                    columnNumber: 29\n                  }, this), typeof m.genTimeSec === 'number' && /*#__PURE__*/_jsxDEV(\"span\", {\n                    style: {\n                      color: '#6b7280',\n                      fontSize: 12\n                    },\n                    children: [\" \", m.genTimeSec.toFixed(2), \"s\"]\n                  }, void 0, true, {\n                    fileName: _jsxFileName,\n                    lineNumber: 743,\n                    columnNumber: 29\n                  }, this)]\n                }, void 0, true, {\n                  fileName: _jsxFileName,\n                  lineNumber: 734,\n                  columnNumber: 25\n                }, this)]\n              }, void 0, true, {\n                fileName: _jsxFileName,\n                lineNumber: 732,\n                columnNumber: 23\n              }, this)]\n            }, m.id, true, {\n              fileName: _jsxFileName,\n              lineNumber: 707,\n              columnNumber: 19\n            }, this);\n          })]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 672,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          ref: barRef,\n          style: {\n            position: 'fixed',\n            left: 0,\n            right: 0,\n            bottom: 0,\n            paddingBottom: 'env(safe-area-inset-bottom)'\n          },\n          children: /*#__PURE__*/_jsxDEV(\"div\", {\n            ref: barInnerRef,\n            style: {\n              maxWidth: 980,\n              margin: '12px auto',\n              position: 'relative'\n            },\n            children: [mediaPreview && /*#__PURE__*/_jsxDEV(\"img\", {\n              src: mediaPreview,\n              alt: \"preview\",\n              style: {\n                position: 'absolute',\n                bottom: '100%',\n                left: 0,\n                width: 56,\n                height: 56,\n                objectFit: 'cover',\n                borderRadius: 12,\n                boxShadow: '0 6px 20px rgba(0,0,0,0.12)',\n                marginBottom: 8\n              }\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 757,\n              columnNumber: 19\n            }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n              style: {\n                display: 'flex',\n                alignItems: 'flex-end',\n                gap: 8,\n                background: '#ffffff',\n                border: '1px solid #e5e7eb',\n                borderRadius: 16,\n                padding: 8,\n                paddingBottom: 12\n              },\n              children: [/*#__PURE__*/_jsxDEV(\"button\", {\n                \"aria-label\": \"attach\",\n                onClick: () => {\n                  var _document$getElementB2;\n                  return (_document$getElementB2 = document.getElementById('bottom-file')) === null || _document$getElementB2 === void 0 ? void 0 : _document$getElementB2.click();\n                },\n                style: {\n                  width: 44,\n                  height: 44,\n                  borderRadius: 12,\n                  border: '1px solid #e5e7eb',\n                  background: '#fff',\n                  color: '#6b7280',\n                  display: 'grid',\n                  placeItems: 'center',\n                  boxShadow: '0 1px 4px rgba(0,0,0,0.04)',\n                  flexShrink: 0\n                },\n                children: /*#__PURE__*/_jsxDEV(IconPaperclip, {}, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 776,\n                  columnNumber: 21\n                }, this)\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 769,\n                columnNumber: 19\n              }, this), /*#__PURE__*/_jsxDEV(\"input\", {\n                id: \"bottom-file\",\n                accept: \"*/*\",\n                type: \"file\",\n                style: {\n                  display: 'none'\n                },\n                onChange: onPickMedia\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 778,\n                columnNumber: 19\n              }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n                style: {\n                  flexShrink: 0\n                }\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 779,\n                columnNumber: 19\n              }, this), /*#__PURE__*/_jsxDEV(AutoTextarea, {\n                value: text,\n                onChange: e => setText(e.target.value),\n                onSend: sendMessage,\n                placeholder: \"What do you want to know?\"\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 782,\n                columnNumber: 19\n              }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n                onClick: startVoice,\n                \"aria-label\": \"voice\",\n                title: \"Voice\",\n                style: {\n                  width: 44,\n                  height: 44,\n                  borderRadius: '50%',\n                  background: '#0f172a',\n                  color: 'white',\n                  border: '1px solid #0f172a',\n                  display: 'grid',\n                  placeItems: 'center',\n                  boxShadow: '0 12px 28px rgba(2,6,23,0.35)',\n                  flexShrink: 0\n                },\n                children: /*#__PURE__*/_jsxDEV(IconMic, {}, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 796,\n                  columnNumber: 21\n                }, this)\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 789,\n                columnNumber: 19\n              }, this)]\n            }, void 0, true, {\n              fileName: _jsxFileName,\n              lineNumber: 759,\n              columnNumber: 17\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 755,\n            columnNumber: 15\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 754,\n          columnNumber: 13\n        }, this)]\n      }, void 0, true)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 610,\n      columnNumber: 7\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 575,\n    columnNumber: 5\n  }, this);\n};\n_s3(ChatPage, \"/iM70FAz/2qJ25+Wk2WbpDjW2m8=\");\n_c11 = ChatPage;\nexport default ChatPage;\nvar _c, _c2, _c3, _c4, _c5, _c6, _c7, _c8, _c9, _c0, _c1, _c10, _c11;\n$RefreshReg$(_c, \"IconPaperclip\");\n$RefreshReg$(_c2, \"IconMic\");\n$RefreshReg$(_c3, \"IconCopy\");\n$RefreshReg$(_c4, \"IconThumbUp\");\n$RefreshReg$(_c5, \"IconThumbDown\");\n$RefreshReg$(_c6, \"Avatar\");\n$RefreshReg$(_c7, \"Lightbox\");\n$RefreshReg$(_c8, \"MessageBubble\");\n$RefreshReg$(_c9, \"TypingBubble\");\n$RefreshReg$(_c0, \"AutoTextarea$React.forwardRef\");\n$RefreshReg$(_c1, \"AutoTextarea\");\n$RefreshReg$(_c10, \"Toast\");\n$RefreshReg$(_c11, \"ChatPage\");","map":{"version":3,"names":["React","useEffect","useRef","useState","Helmet","jsxDEV","_jsxDEV","Fragment","_Fragment","IconPaperclip","props","width","height","viewBox","fill","stroke","strokeWidth","children","d","strokeLinecap","strokeLinejoin","fileName","_jsxFileName","lineNumber","columnNumber","_c","IconMic","x","y","rx","_c2","IconCopy","_c3","IconThumbUp","_c4","IconThumbDown","_c5","actionBtnStyle","active","background","border","color","padding","borderRadius","display","alignItems","gap","cursor","boxShadow","userSelect","transition","Avatar","style","placeItems","fontWeight","_c6","Lightbox","src","alt","open","onClose","_s","prev","document","body","overflow","onKey","e","key","window","addEventListener","removeEventListener","role","onClick","target","currentTarget","position","inset","zIndex","backdropFilter","top","right","maxWidth","maxHeight","objectFit","_c7","MessageBubble","media","onImageLoad","onPreview","isStreaming","isUser","justifyItems","lineHeight","onLoad","whiteSpace","_c8","TypingBubble","marginBottom","animation","left","bottom","_c9","AutoTextarea","_s2","forwardRef","_c0","value","onChange","onSend","placeholder","ref","localRef","textareaRef","autoSize","el","current","max","h","Math","min","scrollHeight","overflowY","onKeyDown","metaKey","ctrlKey","shiftKey","preventDefault","requestAnimationFrame","rows","flex","outline","fontSize","minHeight","resize","wordBreak","_c1","Toast","show","transform","opacity","pointerEvents","_c10","ChatPage","_s3","CHAT_SERVICE_BASE","messages","setMessages","text","setText","mediaPreview","setMediaPreview","mediaFile","setMediaFile","recording","setRecording","user","setUser","barRef","barInnerRef","bottomPad","setBottomPad","ratings","setRatings","copiedId","setCopiedId","streamingText","setStreamingText","setIsStreaming","historyCursor","setHistoryCursor","loadingHistory","setLoadingHistory","hasMore","setHasMore","chatActivated","setChatActivated","historyBuffer","setHistoryBuffer","lightboxOpen","setLightboxOpen","lightboxSrc","setLightboxSrc","anchorMsgIdRef","messagesListRef","topSentinelRef","inFlightCursorRef","scrollToMsgById","id","behavior","offset","querySelector","getBoundingClientRect","scrollY","scrollTo","update","_barRef$current$offse","_barRef$current","offsetHeight","ro","ResizeObserver","observe","disconnect","mapItemToMessage","message_id","Date","now","content","fetchHistory","toBuffer","url","URL","encodeURIComponent","searchParams","set","res","fetch","toString","ok","Error","j","json","items","Array","isArray","ascending","reverse","map","listEl","prevHeight","documentElement","m","setTimeout","newHeight","scrollTop","scrollBy","next_cursor","Boolean","_","onHistoryScroll","onWinScroll","passive","observer","IntersectionObserver","entries","entry","isIntersecting","root","rootMargin","threshold","compute","rect","cs","getComputedStyle","margin","parseFloat","marginTop","credentials","data","handleRate","val","undefined","handleCopy","textVal","navigator","clipboard","writeText","sendMessage","newMsgs","push","userAnchorId","length","concat","assistantId","_user$id","_user$name","method","headers","JSON","stringify","user_id","username","name","message","fullReply","genTimeSec","gen_time_sec","words","split","currentText","i","msg","Promise","resolve","error","console","startVoice","alert","SR","SpeechRecognition","webkitSpeechRecognition","rec","lang","interimResults","maxAlternatives","onresult","t","results","transcript","onend","onerror","start","onPickMedia","_e$target$files","f","files","createObjectURL","showHero","alignContent","_document$getElementB","getElementById","click","flexShrink","accept","type","title","gridAutoRows","paddingBottom","onScroll","disabled","rated","scrollMarginTop","audio","duration","toFixed","_document$getElementB2","_c11","$RefreshReg$"],"sources":["/Users/khangtuan/Documents/eq_test/eq_test_frontend_v2/src/views/page-chat.js"],"sourcesContent":["import React, { useEffect, useRef, useState } from 'react'\nimport { Helmet } from 'react-helmet'\n// import VoiceRecorder from '../components/VoiceRecorder'\n// import AudioBubble from '../components/AudioBubble'\n/* ==== Icons ==== */\nconst IconPaperclip = (props) => (\n  <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.7\" {...props}>\n    <path d=\"M21 11L10 22a5 5 0 0 1-7-7l11-11a3 3 0 0 1 4 4L8 19a1.5 1.5 0 0 1-2-2l9-9\" strokeLinecap=\"round\" strokeLinejoin=\"round\"/>\n  </svg>\n)\n\nconst IconMic = (props) => (\n  <svg width=\"18\" height=\"18\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.8\" {...props}>\n    <rect x=\"9\" y=\"2\" width=\"6\" height=\"12\" rx=\"3\" />\n    <path d=\"M5 11a7 7 0 0 0 14 0\" />\n    <path d=\"M12 19v3\" />\n  </svg>\n)\n\nconst IconCopy = (props) => (\n  <svg width=\"18\" height=\"18\" viewBox=\"0 0 24 24\" fill=\"none\" {...props}>\n    <rect x=\"9\" y=\"9\" width=\"11\" height=\"11\" rx=\"2\" stroke=\"currentColor\" strokeWidth=\"1.7\"/>\n    <rect x=\"4\" y=\"4\" width=\"11\" height=\"11\" rx=\"2\" stroke=\"currentColor\" strokeWidth=\"1.7\"/>\n  </svg>\n)\n\nconst IconThumbUp = (props) => (\n  <svg width=\"18\" height=\"18\" viewBox=\"0 0 24 24\" fill=\"none\" {...props}>\n    <path d=\"M14 10V5a2 2 0 0 0-2-2l-3 7H5a2 2 0 0 0-2 2v7h10.3a3 3 0 0 0 2.9-2.1l2.1-6.2A2 2 0 0 0 16.4 9H14z\" stroke=\"currentColor\" strokeWidth=\"1.7\" strokeLinejoin=\"round\"/>\n  </svg>\n)\n\nconst IconThumbDown = (props) => (\n  <svg width=\"18\" height=\"18\" viewBox=\"0 0 24 24\" fill=\"none\" {...props}>\n    <path d=\"M10 14v5a2 2 0 0 0 2 2l3-7h4a2 2 0 0 0 2-2V5H10.7a3 3 0 0 0-2.9 2.1L5.7 13.3A2 2 0 0 0 7.6 16H10z\" stroke=\"currentColor\" strokeWidth=\"1.7\" strokeLinejoin=\"round\"/>\n  </svg>\n)\n\n/*  Buttons (copy/like/dislike) */\nconst actionBtnStyle = (active=false) => ({\n  background: active ? '#111827' : '#fff',\n  border: `1px solid ${active ? '#111827' : '#e5e7eb'}`,\n  color: active ? '#ffffff' : '#6b7280',\n  padding: '6px 10px',\n  borderRadius: 10,\n  display: 'inline-flex',\n  alignItems: 'center',\n  gap: 6,\n  cursor: 'pointer',\n  boxShadow: active ? '0 2px 10px rgba(0,0,0,0.15)' : '0 1px 4px rgba(0,0,0,0.04)',\n  userSelect: 'none',\n  transition: 'all .15s ease'\n})\n\n/* ==== Avatar ==== */\nconst Avatar = () => (\n  <div style={{ width: 64, height: 64, borderRadius: 12, background: '#e5e7eb', display: 'grid', placeItems: 'center' }}>\n    <span style={{ fontWeight: 700 }}>E</span>\n  </div>\n)\n\n/* ==== Lightbox ==== */\nconst Lightbox = ({ src, alt, open, onClose }) => {\n  // khoá scroll nền khi mở\n  useEffect(() => {\n    if (!open) return\n    const prev = document.body.style.overflow\n    document.body.style.overflow = 'hidden'\n    return () => { document.body.style.overflow = prev }\n  }, [open])\n\n  useEffect(() => {\n    if (!open) return\n    const onKey = (e) => { if (e.key === 'Escape') onClose?.() }\n    window.addEventListener('keydown', onKey)\n    return () => window.removeEventListener('keydown', onKey)\n  }, [open, onClose])\n\n  if (!open) return null\n  return (\n    <div\n      role=\"dialog\"\n      aria-modal=\"true\"\n      onClick={(e) => { if (e.target === e.currentTarget) onClose?.() }}\n      style={{\n        position: 'fixed', inset: 0, zIndex: 9999,\n        background: 'rgba(15,23,42,.55)',\n        backdropFilter: 'blur(2px)',\n        display: 'grid', placeItems: 'center',\n        padding: 16\n      }}\n    >\n      <button\n        onClick={onClose}\n        aria-label=\"Close\"\n        style={{\n          position: 'absolute', top: 16, right: 16,\n          width: 36, height: 36, borderRadius: '50%',\n          background: 'rgba(255,255,255,.9)', border: '1px solid #e5e7eb',\n          display: 'grid', placeItems: 'center', fontWeight: 700, cursor: 'pointer'\n        }}\n      >×</button>\n\n      <img\n        src={src}\n        alt={alt || 'preview'}\n        style={{\n          maxWidth: 'min(92vw, 1000px)',\n          maxHeight: 'min(92vh, 1000px)',\n          objectFit: 'contain',\n          borderRadius: 16,\n          boxShadow: '0 20px 60px rgba(0,0,0,.35)',\n          background: '#0b0f19'\n        }}\n      />\n    </div>\n  )\n}\n\n/* ==== Message Bubble ==== */\nconst MessageBubble = ({ role, children, media, onImageLoad, onPreview, isStreaming = false }) => {\n  const isUser = role === 'user'\n  return (\n    <div style={{ display: 'grid', justifyItems: isUser ? 'end' : 'start' }}>\n      <div style={{\n        maxWidth: 720,\n        background: isUser ? '#111827' : '#ffffff',\n        color: isUser ? 'white' : '#111827',\n        border: isUser ? 'none' : '1px solid #e5e7eb',\n        padding: media ? 8 : 12,\n        borderRadius: 16,\n        boxShadow: isUser ? '0 4px 14px rgba(0,0,0,0.15)' : '0 4px 14px rgba(0,0,0,0.06)',\n        display: 'inline-block',\n        width: 'fit-content',\n        lineHeight: 1.6,\n      }}>\n        {media ? (\n          <img\n            src={media}\n            alt=\"attachment\"\n            onLoad={onImageLoad}\n            onClick={() => onPreview?.(media)}\n            style={{ width: 260, borderRadius: 12, cursor: 'zoom-in', display: 'block' }}\n          />\n        ) : (\n          <div style={{ whiteSpace: 'pre-wrap' }}>{children}</div>\n        )}\n      </div>\n    </div>\n  )\n}\n\n/* ==== Typing indicator bubble (iMessage/Messenger style) ==== */\nconst TypingBubble = () => {\n  return (\n    <div style={{ display: 'grid', justifyItems: 'start', marginBottom: 16 }}>\n      <div style={{\n        position: 'relative',\n        background: '#ebeef2',\n        height: 50,\n        color: '#374151',\n        border: '1px solid #e5e7eb',\n        borderRadius: 20,\n        padding: '10px 14px',\n        display: 'inline-flex',\n        alignItems: 'center',\n        gap: 6,\n        boxShadow: '0 4px 14px rgba(0,0,0,0.06)'\n      }}>\n        <span style={{ width: 8, height: 8, borderRadius: '50%', background: '#9ca3af', animation: 'typingDot 1.2s infinite ease-in-out' }} />\n        <span style={{ width: 8, height: 8, borderRadius: '50%', background: '#9ca3af', animation: 'typingDot 1.2s infinite ease-in-out .15s' }} />\n        <span style={{ width: 8, height: 8, borderRadius: '50%', background: '#9ca3af', animation: 'typingDot 1.2s infinite ease-in-out .3s' }} />\n\n        {/* Tail */}\n        <span style={{ position: 'absolute', left: -6, bottom: -2, width: 10, height: 10, borderRadius: '50%', background: '#ebeef2', border: '1px solid #e5e7eb' }} />\n        <span style={{ position: 'absolute', left: -14, bottom: -6, width: 8, height: 8, borderRadius: '50%', background: '#ebeef2', border: '1px solid #e5e7eb' }} />\n      </div>\n    </div>\n  )\n}\n\n/* ==== Auto Textarea ==== */\nconst AutoTextarea = React.forwardRef(function AutoTextarea(\n  { value, onChange, onSend, placeholder, style },\n  ref\n) {\n  const localRef = useRef(null)\n  const textareaRef = ref || localRef\n\n  const autoSize = () => {\n    const el = textareaRef.current\n    if (!el) return\n    el.style.height = 'auto'\n    const max = 240\n    const h = Math.min(el.scrollHeight, max)\n    el.style.height = h + 'px'\n    el.style.overflowY = el.scrollHeight > max ? 'auto' : 'hidden'\n  }\n\n  useEffect(() => { autoSize() }, [value])\n\n  const onKeyDown = (e) => {\n    if (e.key === 'Enter') {\n      if (e.metaKey || e.ctrlKey || e.shiftKey) return\n      e.preventDefault()\n      onSend?.()\n    }\n  }\n\n  return (\n    <textarea\n      ref={textareaRef}\n      value={value}\n      onChange={(e) => { onChange(e); requestAnimationFrame(autoSize) }}\n      onKeyDown={onKeyDown}\n      placeholder={placeholder}\n      rows={1}\n      style={{\n        flex: 1,\n        background: 'transparent',\n        color: '#111827',\n        border: 'none',\n        outline: 'none',\n        padding: '12px 12px',\n        fontSize: 18,\n        lineHeight: '24px',\n        minHeight: 44,\n        resize: 'none',\n        overflow: 'hidden',\n        whiteSpace: 'pre-wrap',\n        wordBreak: 'break-word',\n        ...style,\n      }}\n      aria-label=\"Message input\"\n    />\n  )\n})\n\n/* ==== Small toast ==== */\nconst Toast = ({ show, children }) => (\n  <div aria-live=\"polite\" style={{ position: 'absolute', top: -100, left: '50%', transform: 'translateX(-50%)', opacity: show ? 1 : 0, transition: 'opacity .2s ease', pointerEvents: 'none' }}>\n    <div style={{ background: '#111827', color: 'white', padding: '6px 10px', borderRadius: 999, fontSize: 12, boxShadow: '0 6px 18px rgba(0,0,0,.18)' }}>{children}</div>\n  </div>\n)\n\n/* ==== Main Page ==== */\nconst ChatPage = () => {\n  const CHAT_SERVICE_BASE = \"http://localhost:5002\"\n  const [messages, setMessages] = useState([])\n  const [text, setText] = useState('')\n  const [mediaPreview, setMediaPreview] = useState(null)\n  const [mediaFile, setMediaFile] = useState(null)\n  const [recording, setRecording] = useState(false)\n  // Ensure user is defined to avoid ReferenceError in sendMessage\n  const [user, setUser] = useState(null)\n\n  const barRef = useRef(null)\n  const barInnerRef = useRef(null)\n\n  const [bottomPad, setBottomPad] = useState(96)\n  const [ratings, setRatings] = useState({})\n  const [copiedId, setCopiedId] = useState(null)\n  const [streamingText, setStreamingText] = useState('')\n  const [isStreaming, setIsStreaming] = useState(false)\n  const [historyCursor, setHistoryCursor] = useState(null)\n  const [loadingHistory, setLoadingHistory] = useState(false)\n  const [hasMore, setHasMore] = useState(true)\n  const [chatActivated, setChatActivated] = useState(false)\n  const [historyBuffer, setHistoryBuffer] = useState([])\n\n  // Lightbox\n  const [lightboxOpen, setLightboxOpen] = useState(false)\n  const [lightboxSrc, setLightboxSrc] = useState(null)\n\n  // ---- Anchor & scroll helpers ----\n  const anchorMsgIdRef = useRef(null)\n  const messagesListRef = useRef(null)\n  const topSentinelRef = useRef(null)\n  const inFlightCursorRef = useRef(null)\n  const scrollToMsgById = (id, behavior = 'smooth', offset = 16) => {\n    const el = document.querySelector(`[data-mid=\"${id}\"]`)\n    if (!el) return\n    const top = el.getBoundingClientRect().top + window.scrollY - offset\n    window.scrollTo({ top, behavior })\n  }\n\n  /* ==== Padding theo chiều cao input bar ==== */\n  useEffect(() => {\n    if (!barRef.current) return\n    const update = () => {\n      const h = barRef.current?.offsetHeight ?? 0\n      setBottomPad(h + 16)\n    }\n    const ro = new ResizeObserver(update)\n    ro.observe(barRef.current)\n    window.addEventListener('resize', update)\n    update()\n    return () => { ro.disconnect(); window.removeEventListener('resize', update) }\n  }, [])\n\n  // History helpers\n  const mapItemToMessage = (d) => ({\n    id: d.message_id || d.id || Date.now(),\n    role: d.role === 'assistant' ? 'assistant' : 'user',\n    text: d.content || '',\n  })\n\n  const fetchHistory = async (cursor = null, toBuffer = false) => {\n    if (!user?.id || loadingHistory) return\n    if (cursor && inFlightCursorRef.current === cursor) return\n    setLoadingHistory(true)\n    inFlightCursorRef.current = cursor || '__initial__'\n    try {\n      const url = new URL(`/v1/conversation/${encodeURIComponent(user.id)}`, CHAT_SERVICE_BASE)\n      url.searchParams.set('page_size', '10')\n      if (cursor) url.searchParams.set('cursor', cursor)\n      const res = await fetch(url.toString())\n      if (!res.ok) throw new Error('history fetch failed')\n      const j = await res.json()\n      const items = Array.isArray(j?.items) ? j.items : []\n      const ascending = [...items].reverse().map(mapItemToMessage)\n\n      if (!chatActivated && !cursor) {\n        // Only buffer initial history; do not render yet\n        setHistoryBuffer(ascending)\n      } else if (cursor) {\n        const listEl = messagesListRef.current\n        const prevHeight = listEl ? listEl.scrollHeight : document.documentElement.scrollHeight\n        setMessages((m) => [...ascending, ...m])\n        setTimeout(() => {\n          const newHeight = listEl ? listEl.scrollHeight : document.documentElement.scrollHeight\n          if (listEl) {\n            listEl.scrollTop = newHeight - prevHeight\n          } else {\n            window.scrollBy(0, newHeight - prevHeight)\n          }\n        }, 0)\n      } else {\n        setMessages(ascending)\n        setTimeout(() => {\n          if (messagesListRef.current) {\n            messagesListRef.current.scrollTop = messagesListRef.current.scrollHeight\n          }\n        }, 0)\n      }\n\n      setHistoryCursor(j?.next_cursor || null)\n      setHasMore(Boolean(j?.next_cursor))\n    } catch (_) {\n    } finally {\n      setLoadingHistory(false)\n      inFlightCursorRef.current = null\n    }\n  }\n\n  useEffect(() => {\n    if (user?.id) fetchHistory(null, true) // prefetch into buffer only\n    // eslint-disable-next-line\n  }, [user?.id])\n\n  const onHistoryScroll = (e) => {\n    if (!chatActivated) return\n    const el = e.currentTarget\n    if (el.scrollTop <= 100 && historyCursor && !loadingHistory) {\n      fetchHistory(historyCursor)\n    }\n  }\n\n  // Also observe window scroll for cases when body is the scroller\n  useEffect(() => {\n    const onWinScroll = () => {\n      if (!chatActivated) return\n      const top = Math.min(document.documentElement.scrollTop || 0, window.scrollY || 0)\n      if (top <= 100 && historyCursor && !loadingHistory) {\n        fetchHistory(historyCursor)\n      }\n    }\n    window.addEventListener('scroll', onWinScroll, { passive: true })\n    return () => window.removeEventListener('scroll', onWinScroll)\n  }, [chatActivated, historyCursor, loadingHistory])\n\n  // IntersectionObserver to reliably detect when top enters viewport\n  useEffect(() => {\n    if (!topSentinelRef.current) return\n    const observer = new IntersectionObserver((entries) => {\n      const entry = entries[0]\n      if (!chatActivated) return\n      if (entry.isIntersecting && historyCursor && !loadingHistory) {\n        fetchHistory(historyCursor)\n      }\n    }, { root: null, rootMargin: '0px', threshold: 0 })\n    observer.observe(topSentinelRef.current)\n    return () => observer.disconnect()\n  }, [chatActivated, historyCursor, loadingHistory])\n\n  useEffect(() => {\n    const el = barInnerRef.current; if (!el) return\n    const compute = () => {\n      const rect = el.getBoundingClientRect()\n      const cs = window.getComputedStyle(el)\n      const margin = parseFloat(cs.marginTop) + parseFloat(cs.marginBottom)\n      setBottomPad(rect.height + margin + 8)\n    }\n    compute()\n    const ro = new ResizeObserver(compute)\n    ro.observe(el)\n    window.addEventListener('resize', compute)\n    return () => { ro.disconnect(); window.removeEventListener('resize', compute) }\n  }, [])\n\n  // Load current user info (best-effort)\n  useEffect(() => {\n    (async () => {\n      try {\n        const res = await fetch('/api/v1/users/me', { credentials: 'include' })\n        if (!res.ok) return\n        const j = await res.json()\n        setUser(j?.data || null)\n      } catch (_) {}\n    })()\n  }, [])\n\n  /* ==== Copy/Rate ==== */\n  const handleRate = (id, val) => setRatings(prev => ({ ...prev, [id]: prev[id] === val ? undefined : val }))\n  const handleCopy = async (id, textVal) => {\n    try { await navigator.clipboard.writeText(textVal); setCopiedId(id); setTimeout(() => setCopiedId(null), 1200) } catch {}\n  }\n  // const handleSendAudio = ({ blob, url, duration, peaks }) => {\n  //   const id = Date.now()\n  //   // anchor tới message audio mới\n  //   anchorMsgIdRef.current = id\n  //   // thêm message audio vào list\n  //   setMessages(m => m.concat({\n  //     id,\n  //     role: 'user',\n  //     audio: { url, duration, peaks }   // <— AudioBubble sẽ dùng 3 field này\n  //   }))\n  //   // sau render: nhảy viewport tới message audio\n  //   setTimeout(() => {\n  //     if (anchorMsgIdRef.current) scrollToMsgById(anchorMsgIdRef.current, 'smooth')\n  //   }, 0)\n  // }\n  /* ==== Send ==== */\n  const sendMessage = async () => {\n    if (!text && !mediaPreview) return\n\n    const now = Date.now()\n    const newMsgs = []\n    if (mediaPreview) newMsgs.push({ id: now, role: 'user', media: mediaPreview })\n    if (text) newMsgs.push({ id: now + 1, role: 'user', text })\n\n    const userAnchorId = newMsgs[newMsgs.length - 1].id\n    anchorMsgIdRef.current = userAnchorId\n\n    if (!chatActivated) {\n      setMessages(() => historyBuffer.concat(newMsgs))\n      setChatActivated(true)\n      setHistoryBuffer([])\n    } else {\n      setMessages(m => m.concat(newMsgs))\n    }\n    setText('')\n    setMediaPreview(null)\n    setMediaFile(null)\n\n    setTimeout(() => {\n      if (anchorMsgIdRef.current) scrollToMsgById(userAnchorId, 'smooth')\n    }, 0)\n\n    // Create assistant message for fake streaming\n    const assistantId = Date.now() + 2\n    anchorMsgIdRef.current = assistantId\n    setMessages(m => m.concat({ id: assistantId, role: 'assistant', text: '' }))\n    setIsStreaming(true)\n\n    try {\n      // Use regular chat endpoint for faster response\n      const CHAT_SERVICE_BASE = \"http://localhost:5002\"\n      const res = await fetch(`${CHAT_SERVICE_BASE}/v1/letta/chat`, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        // credentials removed to satisfy CORS when allow_origins is \"*\"\n        body: JSON.stringify({\n          //  content: text || '[media]' \n            user_id: user?.id ?? null,\n            username: user?.name ?? 'Guest',\n            message: text || '[media]'\n\n          }),\n      })\n\n      if (!res.ok) throw new Error('Network response was not ok')\n      \n      const j = await res.json()\n      const fullReply = j?.message || 'Chào bạn! Bạn muốn hỏi thêm gì về Emostagram?'\n      const genTimeSec = j?.gen_time_sec\n      \n      // Fake streaming effect - show text word by word\n      const words = fullReply.split(' ')\n      let currentText = ''\n      \n      for (let i = 0; i < words.length; i++) {\n        currentText += (i > 0 ? ' ' : '') + words[i]\n        \n        // Update message with current text\n        setMessages(m => m.map(msg => \n          msg.id === assistantId \n            ? { ...msg, text: currentText }\n            : msg\n        ))\n        \n        // Small delay to make streaming visible\n        await new Promise(resolve => setTimeout(resolve, 50))\n      }\n      \n      // Streaming finished\n      setIsStreaming(false)\n      setTimeout(() => {\n        if (anchorMsgIdRef.current) scrollToMsgById(assistantId, 'smooth')\n      }, 0)\n\n      // Attach generation time to this assistant message so UI can render it\n      if (typeof genTimeSec === 'number') {\n        setMessages(m => m.map(msg =>\n          msg.id === assistantId\n            ? { ...msg, genTimeSec }\n            : msg\n        ))\n      }\n      \n    } catch (error) {\n      console.error('Chat error:', error)\n      setIsStreaming(false)\n      // Update the assistant message with error\n      setMessages(m => m.map(msg => \n        msg.id === assistantId \n          ? { ...msg, text: 'Sorry, something went wrong. Please try again.' }\n          : msg\n      ))\n    }\n  }\n\n  // Voice input\n  const startVoice = () => {\n    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {\n      alert('Voice input not supported in this browser'); return\n    }\n    const SR = window.SpeechRecognition || window.webkitSpeechRecognition\n    const rec = new SR()\n    rec.lang = 'vi-VN'\n    rec.interimResults = false\n    rec.maxAlternatives = 1\n    setRecording(true)\n    rec.onresult = (e) => {\n      const t = e.results[0][0].transcript\n      setText(prev => (prev ? prev + ' ' + t : t))\n    }\n    rec.onend = () => setRecording(false)\n    rec.onerror = () => setRecording(false)\n    rec.start()\n  }\n\n  const onPickMedia = (e) => {\n    const f = e.target.files?.[0]; if (!f) return\n    const url = URL.createObjectURL(f)\n    setMediaPreview(url)\n    setMediaFile(f)\n    // reset để chọn lại cùng file vẫn onChange\n    e.target.value = \"\"\n  }\n\n  const showHero = !chatActivated\n\n  return (\n    <main style={{ minHeight: '100vh', background: '#f8fafc', color: '#111827' }}>\n      <Helmet>\n        <title>Chat - Emostagram</title>\n        <style>{`\n          @keyframes bounce {\n            0%, 80%, 100% { \n              transform: translateY(2px);\n              opacity: .6;\n            }\n            40% { \n              transform: translateY(-2px);\n              opacity: 1;\n            }\n          }\n          @keyframes typingDot {\n            0%, 80%, 100% { \n              transform: translateY(2px);\n              opacity: .55;\n            }\n            40% { \n              transform: translateY(-2px);\n              opacity: 1;\n            }\n          }\n        `}</style>\n      </Helmet>\n\n      {/* Lightbox overlay */}\n      <Lightbox\n        src={lightboxSrc}\n        alt=\"image preview\"\n        open={lightboxOpen}\n        onClose={() => { setLightboxOpen(false); setLightboxSrc(null) }}\n      />\n\n      <div style={{ maxWidth: 980, margin: '0 auto', padding: '16px 16px 0 16px', display: 'grid', gap: 16 }}>\n        {showHero ? (\n          <div style={{ minHeight: '70vh', display: 'grid', alignContent: 'center', justifyItems: 'center', gap: 20 }}>\n            <Avatar />\n            <h1 style={{ marginTop: 8, fontSize: 36, fontWeight: 700 }}>Emostagram</h1>\n            <div style={{ width: '100%', display: 'grid', justifyItems: 'center', gap: 12 }}>\n              {mediaPreview && (\n                <img src={mediaPreview} alt=\"preview\" style={{ width: 72, height: 72, objectFit: 'cover', borderRadius: 14, boxShadow: '0 8px 26px rgba(0,0,0,0.12)' }} />\n              )}\n              <div style={{\n                width: 'min(92vw, 760px)',\n                background: '#ffffff',\n                border: '1px solid #e5e7eb',\n                borderRadius: 18,\n                boxShadow: '0 12px 40px rgba(0,0,0,0.06)',\n                display: 'flex',\n                alignItems: 'flex-end',\n                padding: 8,\n                gap: 8\n              }}>\n                <button\n                  aria-label=\"attach\"\n                  onClick={() => document.getElementById('hero-file')?.click()}\n                  style={{\n                    width: 44, height: 44, borderRadius: 12,\n                    border: '1px solid #e5e7eb', background: '#fff', color: '#6b7280',\n                    display: 'grid', placeItems: 'center',\n                    boxShadow: '0 1px 4px rgba(0,0,0,0.04)',\n                    flexShrink: 0\n                  }}\n                >\n                  <IconPaperclip />\n                </button>\n                <input id=\"hero-file\" accept=\"*/*\" type=\"file\" style={{ display: 'none' }} onChange={onPickMedia} />\n\n                <AutoTextarea\n                  value={text}\n                  onChange={(e) => setText(e.target.value)}\n                  onSend={sendMessage}\n                  placeholder=\"What do you want to know?\"\n                />\n\n                <button\n                  onClick={startVoice}\n                  aria-label=\"voice\"\n                  title=\"Voice\"\n                  style={{\n                    width: 44, height: 44, borderRadius: '50%',\n                    background: '#0f172a', color: 'white', border: '1px solid #0f172a',\n                    display: 'grid', placeItems: 'center',\n                    boxShadow: '0 12px 28px rgba(2,6,23,0.35)',\n                    flexShrink: 0\n                  }}\n                >\n                  <IconMic />\n                </button>\n              </div>\n            </div>\n          </div>\n        ) : (\n          <>\n            {/* Messages list */}\n            <div\n              ref={messagesListRef}\n              style={{\n                display: 'grid',\n                gap: 6,\n                padding: '0 8px',\n                alignItems: 'start',\n                gridAutoRows: 'max-content',\n                margin: 0,\n                paddingBottom: `calc(${bottomPad}px + env(safe-area-inset-bottom, 0px))`\n              }}\n              onScroll={onHistoryScroll}\n            >\n              <div ref={topSentinelRef} style={{ height: 1 }} />\n              {chatActivated && historyCursor && (\n                <div style={{ display: 'grid', justifyItems: 'center', margin: '8px 0' }}>\n                  <button\n                    onClick={() => fetchHistory(historyCursor)}\n                    style={{\n                      padding: '6px 10px',\n                      borderRadius: 10,\n                      border: '1px solid #e5e7eb',\n                      background: '#fff',\n                      color: '#6b7280',\n                      cursor: loadingHistory ? 'not-allowed' : 'pointer'\n                    }}\n                    disabled={loadingHistory}\n                  >\n                    {loadingHistory ? 'Loading…' : 'Load earlier messages'}\n                  </button>\n                </div>\n              )}\n              {messages.map((m) => {\n                const rated = ratings[m.id]\n                return (\n                  <div key={m.id} data-mid={m.id} style={{ display: 'grid', gap: 6, scrollMarginTop: 16 }}>\n                  {isStreaming && m.role === 'assistant' && m.id === anchorMsgIdRef.current && !m.text ? (\n                    <TypingBubble />\n                  ) : m.audio ? (\n                    // ==== Bubble AUDIO ====\n                    <div style={{ padding: 12, background: '#f3f4f6', borderRadius: 12, border: '1px solid #e5e7eb' }}>\n                      Audio message (duration: {m.audio.duration}s)\n                    </div>\n                  ) : (\n                    <MessageBubble\n                      role={m.role}\n                      media={m.media}\n                      onPreview={(src) => { setLightboxSrc(src); setLightboxOpen(true) }}\n                      onImageLoad={() => {\n                        if (anchorMsgIdRef.current === m.id) {\n                          const id = m.id\n                          requestAnimationFrame(() => scrollToMsgById(id, 'auto'))\n                        }\n                      }}\n                      isStreaming={isStreaming && m.role === 'assistant' && m.id === anchorMsgIdRef.current}\n                    >\n                      {m.text}\n                    </MessageBubble>\n                  )}\n                    {m.role === 'assistant' && !(isStreaming && m.id === anchorMsgIdRef.current) && m.text && (\n                      <div style={{ position: 'relative' }}>\n                        <Toast show={copiedId === m.id}>Copy thành công</Toast>\n                        <div style={{ display: 'flex', gap: 8, alignItems: 'center' }}>\n                          <button aria-label=\"copy\" onClick={() => handleCopy(m.id, m.text)} style={actionBtnStyle(copiedId === m.id)}><IconCopy /></button>\n                          {(rated === undefined || rated === 'up') && (\n                            <button aria-label=\"like\" onClick={() => handleRate(m.id, 'up')} style={actionBtnStyle(rated === 'up')} title=\"Like\"><IconThumbUp /></button>\n                          )}\n                          {(rated === undefined || rated === 'down') && (\n                            <button aria-label=\"dislike\" onClick={() => handleRate(m.id, 'down')} style={actionBtnStyle(rated === 'down')} title=\"Dislike\"><IconThumbDown /></button>\n                          )}\n                          {typeof m.genTimeSec === 'number' && (\n                            <span style={{ color: '#6b7280', fontSize: 12 }}> {m.genTimeSec.toFixed(2)}s</span>\n                          )}\n                        </div>\n                      </div>\n                    )}\n                  </div>\n                )\n              })}\n            </div>\n\n            {/* Bottom input bar */}\n            <div ref={barRef} style={{ position: 'fixed', left: 0, right: 0, bottom: 0, paddingBottom: 'env(safe-area-inset-bottom)' }}>\n              <div ref={barInnerRef} style={{ maxWidth: 980, margin: '12px auto', position: 'relative' }}>\n                {mediaPreview && (\n                  <img src={mediaPreview} alt=\"preview\" style={{ position: 'absolute', bottom: '100%', left: 0, width: 56, height: 56, objectFit: 'cover', borderRadius: 12, boxShadow: '0 6px 20px rgba(0,0,0,0.12)', marginBottom: 8 }} />\n                )}\n                <div style={{\n                  display: 'flex',\n                  alignItems: 'flex-end',\n                  gap: 8,\n                  background: '#ffffff',\n                  border: '1px solid #e5e7eb',\n                  borderRadius: 16,\n                  padding: 8,\n                  paddingBottom: 12,\n                }}>\n                  <button aria-label=\"attach\" onClick={() => document.getElementById('bottom-file')?.click()} style={{\n                    width: 44, height: 44, borderRadius: 12,\n                    border: '1px solid #e5e7eb', background: '#fff', color: '#6b7280',\n                    display: 'grid', placeItems: 'center',\n                    boxShadow: '0 1px 4px rgba(0,0,0,0.04)',\n                    flexShrink: 0\n                  }}>\n                    <IconPaperclip />\n                  </button>\n                  <input id=\"bottom-file\" accept=\"*/*\" type=\"file\" style={{ display: 'none' }} onChange={onPickMedia} />\n                  <div style={{ flexShrink: 0 }}>\n                    {/* <VoiceRecorder onSend={handleSendAudio} /> */}\n                  </div>\n                  <AutoTextarea\n                    value={text}\n                    onChange={(e) => setText(e.target.value)}\n                    onSend={sendMessage}\n                    placeholder=\"What do you want to know?\"\n                  />\n\n                  <button onClick={startVoice} aria-label=\"voice\" title=\"Voice\" style={{\n                    width: 44, height: 44, borderRadius: '50%',\n                    background: '#0f172a', color: 'white', border: '1px solid #0f172a',\n                    display: 'grid', placeItems: 'center',\n                    boxShadow: '0 12px 28px rgba(2,6,23,0.35)',\n                    flexShrink: 0\n                  }}>\n                    <IconMic />\n                  </button>\n                </div>\n              </div>\n            </div>\n          </>\n        )}\n      </div>\n    </main>\n  )\n}\n\nexport default ChatPage\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}